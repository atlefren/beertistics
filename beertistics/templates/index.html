{% extends "layout.html" %}

{% block navbar %}
    <li id="user-info">
      <img src="{{session.user['avatar']}}"/>
      <a href="{{session.user['url']}}">{{session.user['name']}}</a>
    </li>
    <li>
      <a href="{{url_for('logout')}}">Log out</a>
    </li>
{% endblock %}

{% block content %}
  <p><em id="basic-stats-message"></em></p>

  <h1>Beer ratings</h1>
  <div id="ratings"><svg></svg></div>

  <h1>ABV vs Rating</h1>
  <div id="abv-vs-rating"><svg></svg></div>

  <h1>Checkins by location</h1>
  <div id="places"><svg></svg></div>

  <h1>Consumption per month</h1>
  <div id="consumption-per-month"><svg></svg></div>
{% endblock %}

{% block script %}
  <script>
    $(document).ready(function() {

        $.getJSON("/api/basic", function(data) {
            $("#basic-stats-message").text(basic_stats_message(data));
        });

        $.getJSON("/api/ratings", function(data) {
            var chart;
            nv.addGraph(function() {
                chart = nv.models.multiBarChart()
                            .showControls(false)
                            .barColor(d3.scale.category20().range());
                chart.y(function(d) { return d.n });
                chart.x(function(d) { return d.rating });
                chart.xAxis.showMaxMin(false);
                chart.yAxis.tickFormat(d3.format(',.0f'));
                
                chart.xAxis.axisLabel('Rating');
                chart.yAxis.axisLabel('Beers');

                chart.margin({bottom: 40, left: 80});

                d3.select('#ratings svg')
                          .datum(data)
                    .transition().duration(500).call(chart);

                nv.utils.windowResize(chart.update);
                chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });

              return chart;
          });
        });

        $.getJSON("/api/abv-vs-rating", function(data) {
          var chart;
          nv.addGraph(function() {
            chart = nv.models.scatterChart()
                          .showDistX(true)
                          .showDistY(true)
                          //.height(500)
                          .x(function(d) { return d.abv })
                          .y(function(d) { return d.rating })
                          .useVoronoi(true)
                          .showLegend(false)
                          .color(d3.scale.category10().range());

            chart.xAxis.axisLabel('Alcohol by volume (ABV)')
            chart.yAxis.axisLabel('Rating')

            chart.xAxis.tickFormat(d3.format('.01f'))
            chart.yAxis.tickFormat(d3.format('.01f'))

            d3.select('#abv-vs-rating svg')
                .datum(data)
              .transition().duration(500)
                .call(chart);

            nv.utils.windowResize(chart.update);

            chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });

            return chart;
          });
        });

        $.getJSON("/api/places", function(data) {
            var chart;
            nv.addGraph(function() {
              chart = nv.models.multiBarHorizontalChart()
                  .x(function(d) { return d.label })
                  .y(function(d) { return d.value })
                  .margin({top: 30, right: 20, bottom: 50, left: 175})
                  .barColor(d3.scale.category20().range())
                  .showControls(false)
                  .showLegend(false);

              chart.yAxis.axisLabel('Number of checkins')
              chart.yAxis.tickFormat(d3.format(',.0f'));

              d3.select('#places svg')
                  .datum(data)
                .transition().duration(500)
                  .call(chart);

              nv.utils.windowResize(chart.update);

              chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });

              return chart;
            });
        });

        $.getJSON("/api/per-month", function(data) {
            var chart;
            nv.addGraph(function() {
                chart = nv.models.multiBarChart()
                            .barColor(d3.scale.category20().range());
                chart.y(function(d) { return d.beers });
                chart.x(function(d) { return d.month });
                chart.xAxis.showMaxMin(false);
                chart.yAxis.tickFormat(d3.format(',.0f'));

                d3.select('#consumption-per-month svg')
                          .datum(data)
                    .transition().duration(500).call(chart);

                nv.utils.windowResize(chart.update);
                chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });

              return chart;
          });
        });

    });


  </script>
{% endblock %}

{% block footer %}
    <div class="footer">
        Build on data provided by <a href="http://untappd.com">Untappd</a>.
    </div>
{% endblock %}